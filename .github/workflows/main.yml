name: Run My Bot Forever

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      # ╪к╪о╪╡┘К╪╡ ╪░╪з┘Г╪▒╪й ╪з┘Б╪к╪▒╪з╪╢┘К╪й ┘Д┘Д┘Е╪╣╪з┘Д╪м╪й ┘Д╪╢┘Е╪з┘Ж ╪╣╪п┘Е ╪з┘Д╪з┘Ж┘З┘К╪з╪▒
      NODE_OPTIONS: "--max-old-space-size=8192"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Maximize CPU & RAM Performance
        # ┘З╪░╪з ╪з┘Д╪м╪▓╪б ┘К┘В┘И┘Е ╪и╪е┘Ж╪┤╪з╪б Swap File ┘Д╪▓┘К╪з╪п╪й ╪з┘Д╪▒╪з┘Е ┘И╪к┘Б╪▒┘К╪║ ┘Е╪│╪з╪н╪й ╪з┘Д┘Е╪╣╪з┘Д╪м
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo sysctl vm.swappiness=10
          echo "ЁЯЪА RAM Capacity Boosted with 8GB Swap & CPU Cleaned"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Google Chrome Stable
        run: |
          sudo apt-get update
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tor xvfb libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libasound2t64 ffmpeg
          pip install undetected_chromedriver selenium requests

      - name: Configure and Start Tor
        run: |
          sudo service tor stop || true
          sudo bash -c 'echo -e "ControlPort 9051\nCookieAuthentication 0\nDataDirectory /var/lib/tor" > /etc/tor/torrc'
          sudo service tor start
          sleep 20

      - name: Start Bot (Max Resource Allocation)
        run: |
          export DISPLAY=:99
          # ╪з╪│╪к╪о╪п╪з┘Е ╪┤╪з╪┤╪й ┘И┘З┘Е┘К╪й ╪и┘Е╪к╪╖┘Д╪и╪з╪к ╪г┘В┘Д ┘Д╪▒┘Б╪╣ ╪│╪▒╪╣╪й ╪з┘Д┘Е╪╣╪з┘Д╪м╪й ┘Д┘Д┘Б┘К╪п┘К┘И
          timeout 350m xvfb-run --auto-servernum --server-args="-screen 0 1280x720x16 -ac +extension GLX +render -noreset" python -u bot_master1.py || echo "тЪая╕П Restarting..."

      - name: Self-Restart Workflow
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ЁЯЪА Triggering self-restart..."
          gh workflow run "Run My Bot Forever"
