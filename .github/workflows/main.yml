name: Run My Bot Forever

on:
  workflow_dispatch: # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  schedule:
    - cron: '0 */6 * * *' # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒØ§Ø­ØªÙŠØ§Ø· ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

permissions:
  actions: write # Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø°Ø§ØªÙŠ

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      # ØªØ®ØµÙŠØµ Ø°Ø§ÙƒØ±Ø© Ø£ÙƒØ¨Ø± Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Maximize CPU Performance
        run: |
          # ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø³ÙŠØ±ÙØ±
          sudo sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/&mitigations=off /' /etc/default/grub || true
          echo "ğŸš€ CPU Optimized"

      - name: Install Google Chrome Stable
        run: |
          sudo apt-get update
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© ÙˆØ§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
          sudo apt-get install -y tor xvfb libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libasound2t64 ffmpeg
          pip install undetected_chromedriver selenium requests

      - name: Configure and Start Tor
        run: |
          sudo service tor stop || true
          sudo bash -c 'echo -e "ControlPort 9051\nCookieAuthentication 0\nDataDirectory /var/lib/tor" > /etc/tor/torrc'
          sudo service tor start
          echo "â³ Waiting for Tor..."
          sleep 20

      - name: Start Bot (High Performance & GUI Fix)
        run: |
          # Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø®Ø·Ø£ cannot connect to chrome Ø¹Ø¨Ø± ØªÙ‡ÙŠØ¦Ø© DISPLAY ÙˆØ´Ø§Ø´Ø© ÙˆÙ‡Ù…ÙŠØ© Ø«Ø§Ø¨ØªØ©
          export DISPLAY=:99
          timeout 350m xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24 -ac +extension GLX +render -noreset" python -u bot_master1.py || echo "âš ï¸ Session limit reached or ended"

      - name: Self-Restart Workflow
        if: always() # ÙŠØ¶Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø¨ÙˆØª
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸš€ Triggering self-restart..."
          gh workflow run "Run My Bot Forever"
